# Python script to unpack RUNPE 32 Bits samples
# Work on x64dbg

from _x64dbg import *
import time

bps = [('msvcrt', 'printf'), ('kernel32', 'CreateRemoteThread'),
       ('ntdll.dll', 'NtWriteVirtualMemory'), ('Kernel32', 'WriteProcessMemory'),
       ('Kernel32.dll', 'LoadLibraryA'), ('Kernel32.dll', 'LoadLibraryExA'),
       ('Kernel32.dll', 'LoadLibraryExW'), ('Kernel32.dll', 'LoadLibraryW'),
       ('Kernel32.dll', 'ResumeThread'), ('Kernel32.dll', 'CreateProcessA'),
       ('Kernel32.dll', 'CreateProcessW')]
outbp = {}


def bpcallback():
    """ Called on breakpoint """
    eip = GetEIP()  # Current EIP
    seip = ReadDword(GetESP())   # -5 pour top stack
    if seip < 0x70000000:  # Not called from kernel32.dll
        print "--> 0x%x call %s in %s" % (seip, outbp[eip][1], outbp[eip][0])
        setallbp()

    # Block Halt thread resuming
    if outbp[eip][1] in ['ResumeThread']:
        print "--> Task Resumed request : dump it !"
        pass
    # Detect PE during memory copy
    elif outbp[eip][1] in ['WriteProcessMemory']:
        ptrstr = ReadDword(GetESP() + 12)  # Offset Source
        exestr = ReadWord(ptrstr)
        if exestr == 0x5a4d:  # MZ
            print "--> ExeFound at 0x%x" % (ptrstr)
        else:
            # Toto decrotte pe ici
            DbgCmdExecDirect("run")
    # Print out the name of the process created
    elif outbp[eip][1] in ['CreateProcessA', 'CreateProcessW']:
        ptrstr = ReadDword(GetESP() + 4)
        exestr = ""
        DbgGetStringAt(ptrstr, exestr)
        print "--> Exec Param at 0x%x" % ptrstr
        print exestr
        DbgCmdExecDirect("run")
    else:
        DbgCmdExecDirect("run")


def setallbp():
    """ Set all breakpoints """
    global outbp
    for bp in bps:
        eip = pluginsdk.RemoteGetProcAddress(bp[0], bp[1])
        if eip != 0:
            if eip not in outbp:
                outbp[eip] = (bp[0], bp[1])
                print "--> Breaking %s" % bp[1]
                Breakpoint.add(eip, bpcallback)

# Set breakpoints
GuiLogClear()
setallbp()
