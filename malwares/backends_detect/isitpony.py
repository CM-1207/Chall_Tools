#!/usr/bin/env python3
# coding=utf-8
import sys
import requests
import hashlib
import string
import random

# Validate that the backend is a Pony Stealer

# page usuals
pages = ["admin.php", "config.php", "setup.php", "includes/design/images/favicon.ico"]


def page2folder(arg):
    """
    Remove a page from uri

    args:
        arg (str) string
    return
        str
    """
    arg = arg.split("/")
    return "/".join(arg[:-1])


# Functions
def getparam(count):
    """Retrieve the parameters appended """
    if len(sys.argv) != count + 1:
        print('give only the suspected URI')
        print('To Use: %s my params' % sys.argv[0])
        sys.exit(1)
    else:
        return sys.argv[1]


def get(uri):
    headers = requests.utils.default_headers()
    headers.update({'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36'})
    try:
        r = requests.get(uri, timeout=15, headers=headers)
    except requests.exceptions.MissingSchema:
        print('Warning : Invalid Scheme')
        return 000, ""
    except:
        return 000, ""
    return r.status_code, r.text


def notpony():
    print('Not Pony')
    sys.exit(1)


def pony():
    print('!! Pony backend')
    sys.exit(0)


def checkpony(uri):
    baseuri = page2folder(uri)
    print('* Validating 404 Pages')
    print("  - Fetch %s on %s" % ('gate.php', baseuri)),
    code, body = get(baseuri +"/"+ 'gate.php')
    if code != 404:
        print("Http code: %s" % code),
        print("404 Expected")
        notpony()
    print("  - Fetch %s on %s" % ('404.html', baseuri)),
    code, body4 = get(baseuri +"/"+ '404.html')
    if code == 200 or code == 404):
        print("Http code: %s" % code),
        print("! 200 or 404 Expected")
        notpony()
    if body != body4:
        print ('! 404 Page differs')
        notpony()
    print('* Retrieving Real 404')
    pagerandom = ''.join(random.choice(string.ascii_uppercase + string.digits) for _ in range(16)) + ".html"
    code, body = get(baseuri +"/"+ pagerandom)
    if body == body4:
        print ('! 404 Page does not differs')
        notpony()
    print('* Retrieving Pages')
    for page in pages:
        print("  - Fetch %s on %s" % (page, baseuri)),
        code, body = get(baseuri +"/"+ page)
        if code != 200:
            notpony()
    pony()


# Main Code #####
def main():
    uri = getparam(1)
    checkpony(uri)


if __name__ == '__main__':
    main()
